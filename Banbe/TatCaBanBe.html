<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facebook - T·∫•t c·∫£ b·∫°n b√®</title>
    <link rel="stylesheet" href="banbe.css">
    <style>
        /* Th√™m style cho trang b·∫°n b√® */
        .friends-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            padding: 16px;
        }

        .friend-item {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.2s;
        }

        .friend-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .friend-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .friend-info {
            padding: 12px;
        }

        .friend-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .friend-mutual {
            color: #65676B;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .friend-actions {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .friend-btn {
            padding: 8px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }

        .message-btn {
            background-color: #1B74E4;
            color: white;
        }

        .message-btn:hover {
            background-color: #166FE5;
        }

        .remove-btn {
            background-color: #E4E6EB;
            color: #050505;
        }

        .remove-btn:hover {
            background-color: #D8DADF;
        }

        .search-bar {
            margin: 16px;
            padding: 8px 12px;
            border-radius: 20px;
            border: none;
            background-color: #F0F2F5;
            width: calc(100% - 56px);
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <a href="../test.html"><img src="../img/logo.png" alt="Facebook Logo" class="logo"></a>
            <input type="text" placeholder="T√¨m ki·∫øm tr√™n Facebook">
        </div>
        <div class="header-center">
            <button class="nav-icon active">
                <a href="../test.html"><img src="../img/home.png" alt="Home"></a>
            </button>
            <button class="nav-icon">
                <img src="../img/flag.png" alt="Flag">
            </button>
            <button class="nav-icon">
                <img src="../img/watch.png" alt="Watch">
            </button>
            <button class="nav-icon">
                <a href="../marketplace/market.html">
                    <img src="../img/marketplace.png" alt="Marketplace">
                </a>
            </button>
            <a href="../Group/group.html">
                <button id="nav-group" class="nav-icon">
                    <img src="../img/group.png" alt="Group">
                </button>
            </a>
        </div>
        <div class="header-right">
            <button class="user-icon">
                <img src="../img/home_menu.png" alt="Menu">
            </button>
            <button class="user-icon">
                <a href="../messenger/mess.html">
                    <img src="../img/messenger.png" alt="Messenger">
                </a>
            </button>
            <button class="user-icon">
                <img src="../img/notification.png" alt="Notifications">
            </button>
            <button class="user-icon" id="profile-icon">
                <img src="../img/profile.png" alt="Profile">
            </button>
            <!-- Dropdown Menu -->
            <div class="profile-dropdown" id="profile-dropdown">
                <div class="dropdown-header">
                    <img src="../img/profile.png" alt="Profile">
                    <span>L∆∞∆°ng Tri Tu·ªá</span>
                </div>
                <div class="dropdown-item">
                    <span class="icon">üë§</span>
                    <span>Xem t·∫•t c·∫£ trang c√° nh√¢n</span>
                </div>
                <div class="dropdown-item">
                    <span class="icon">‚öôÔ∏è</span>
                    <span>C√†i ƒë·∫∑t v√† quy·ªÅn ri√™ng t∆∞</span>
                    <span class="arrow">></span>
                </div>
                <div class="dropdown-item">
                    <span class="icon">‚ùì</span>
                    <span>Tr·ª£ gi√∫p v√† h·ªó tr·ª£</span>
                    <span class="arrow">></span>
                </div>
                <div class="dropdown-item">
                    <span class="icon">üåô</span>
                    <span>M√†n h√¨nh & tr·ª£ nƒÉng</span>
                    <span class="arrow">></span>
                </div>
                <div class="dropdown-item">
                    <span class="icon">üí¨</span>
                    <span>ƒê√≥ng g√≥p √Ω ki·∫øn</span>
                </div>
                <div class="dropdown-item">
                    <span class="icon">üö™</span>
                    <span><a href="../facebook-clone-fe/sign_in.html">ƒêƒÉng xu·∫•t</a></span>
                </div>
                <div class="dropdown-footer">
                    <p>Quy·ªÅn ri√™ng t∆∞ ‚Ä¢ ƒêi·ªÅu kho·∫£n ‚Ä¢ Qu·∫£ng c√°o ‚Ä¢ L·ª±a ch·ªçn qu·∫£ng c√°o ‚Ä¢ Cookie ‚Ä¢ Xem th√™m ‚Ä¢ Meta ¬© 2025
                    </p>
                    <p>Phi√™n b·∫£n m·ªõi</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h2>B·∫°n b√®</h2>
            <ul>
                <li><a href="./banbe.html">üë• L·ªùi m·ªùi k·∫øt b·∫°n</a></li>
                <li class="active"><a href="./TatCaBanBe.html">üë§ T·∫•t c·∫£ b·∫°n b√®</a></li>
            </ul>
        </div>

        <!-- All Friends -->
        <div class="main-content">
            <h2>T·∫•t c·∫£ b·∫°n b√®</h2>
            <input type="text" class="search-bar" placeholder="T√¨m ki·∫øm b·∫°n b√®">
            <div class="friends-list" id="friendsList"></div>
        </div>
    </div>

    <script>
        // L·∫•y c√°c ph·∫ßn t·ª≠
        const profileIcon = document.getElementById('profile-icon');
        const profileDropdown = document.getElementById('profile-dropdown');

        // Th√™m s·ª± ki·ªán click cho bi·ªÉu t∆∞·ª£ng h·ªì s∆°
        profileIcon.addEventListener('click', () => {
            // Toggle class 'active' ƒë·ªÉ hi·ªÉn th·ªã/·∫©n dropdown
            profileDropdown.classList.toggle('active');
        });

        // ·∫®n dropdown khi nh·∫•p ra ngo√†i
        document.addEventListener('click', (event) => {
            if (!profileIcon.contains(event.target) && !profileDropdown.contains(event.target)) {
                profileDropdown.classList.remove('active');
            }
        });

        // H√†m fetch API ƒë·ªÉ l·∫•y danh s√°ch b·∫°n b√®
        async function fetchFriends() {
            const bearerToken = localStorage.getItem('accessToken');
            // const bearerToken = 'eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJwaHVvbmd0dWFuQGdtYWlsLmNvbSIsImlhdCI6MTc0OTAyNjA5MywiZXhwIjoxNzQ5MTEyNDkzfQ.I3xuGieyFQwSXbfC7NMadkWATYNsZEe4ckUlvyfJyLAwPaviKKEJfVpbKn14wOywoC5YEiuV8a-eIkhWtZ6NVA';
            const apiUrl = 'http://localhost:8080/api/friend/list';

            try {
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${bearerToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                return await response.json();
            } catch (error) {
                console.error('Error fetching friends:', error);
                return []; // Tr·∫£ v·ªÅ m·∫£ng r·ªóng n·∫øu c√≥ l·ªói
            }
        }

        // Function to render friends list t·ª´ API data
        async function renderFriendsList() {
            const friendsListContainer = document.getElementById("friendsList");
            friendsListContainer.innerHTML = ""; // Clear existing content

            // Hi·ªÉn th·ªã tr·∫°ng th√°i loading
            // friendsListContainer.innerHTML = '<p>ƒêang t·∫£i danh s√°ch b·∫°n b√®...</p>';

            // L·∫•y d·ªØ li·ªáu t·ª´ API
            const friendsData = await fetchFriends();

            // N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu
            if (!friendsData || friendsData.length === 0) {
                friendsListContainer.innerHTML = '<p>Kh√¥ng c√≥ b·∫°n b√® n√†o ƒë·ªÉ hi·ªÉn th·ªã</p>';
                return;
            }

            // Render danh s√°ch b·∫°n b√®
            friendsData.forEach(friend => {
                const friendItem = document.createElement("div");
                friendItem.classList.add("friend-item");

                // X·ª≠ l√Ω avatar m·∫∑c ƒë·ªãnh n·∫øu null
                const avatarUrl = friend.avatar || 'https://static.vecteezy.com/system/resources/previews/009/292/244/non_2x/default-avatar-icon-of-social-media-user-vector.jpg';

                friendItem.innerHTML = `
                    <img src="${avatarUrl}" alt="Profile" class="friend-image">
                    <div class="friend-info">
                        <div class="friend-name">${friend.fullName || `${friend.firstName} ${friend.lastName}`}</div>
                        <div class="friend-mutual">0 b·∫°n chung</div> <!-- C√≥ th·ªÉ thay b·∫±ng d·ªØ li·ªáu th·ª±c t·∫ø n·∫øu API c√≥ -->
                        <div class="friend-actions">
                            <button class="friend-btn message-btn" onclick="handleMessage(this)">Nh·∫Øn tin</button>
                            <button class="friend-btn remove-btn" onclick="handleRemoveFriend(this)" data-id="${friend.userId}">H·ªßy k·∫øt b·∫°n</button>
                        </div>
                    </div>
                `;

                friendsListContainer.appendChild(friendItem);
            });
        }

        // Function to handle message action
        function handleMessage(button) {
            alert(`Nh·∫Øn tin cho ${button.parentElement.parentElement.querySelector('.friend-name').textContent}`);
        }

        // Function to handle remove friend action
        function handleRemoveFriend(button) {
            const friendItem = button.closest('.friend-item');
            const friendName = friendItem.querySelector('.friend-name').textContent;
            const friendId = button.getAttribute('data-id'); // L·∫•y friendId t·ª´ data attribute
            alert(`H·ªßy k·∫øt b·∫°n v·ªõi ${friendId}`);
            if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy k·∫øt b·∫°n v·ªõi ${friendName}?`)) {
                friendItem.remove();
                alert(`ƒê√£ h·ªßy k·∫øt b·∫°n v·ªõi ${friendName}`);

                // G·ªçi API ƒë·ªÉ x√≥a b·∫°n b√®
                deleteFriend(friendId);
            }
        }

        // Render friends list on page load
        window.onload = renderFriendsList;

        // H√†m g·ªçi API x√≥a b·∫°n b√® 
        async function deleteFriend(friendId) {
            const bearerToken = localStorage.getItem('accessToken');
            const apiUrl = `http://localhost:8080/api/friend/remove/${friendId}`; // S·ª≠a endpoint cho ph√π h·ª£p

            try {
                const response = await fetch(apiUrl, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${bearerToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to delete friend');
                }

                const result = await response;
                console.log('Delete friend success:', result);
                return result;
            } catch (error) {
                console.error('Error deleting friend:', error);
                alert('L·ªói khi h·ªßy k·∫øt b·∫°n: ' + error.message);
                return null;
            }
        }
    </script>
</body>

</html>